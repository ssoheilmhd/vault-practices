Vault Migration Scripts
Introduction

In Vault service, different storage methodologies exist, and migrating data between these storage backends (e.g., from Consul to Raft) can be challenging. Additionally, when upgrading from very old versions to much newer ones, data migration becomes complex due to potential database migrations between application versions.

These scripts provide a solution by accessing the Vault service at the application layer to extract critical information from the source and restore it to the specified destination.

Note: These scripts are designed specifically for ASA's usage patterns and do not cover all possible scenarios.

Project link: [Insert your project link here]
Backup from Old Vault

The backup script captures the following information:

    Secrets: Only secrets created on the kv2 engine (all secrets in staging were created this way)

    Policies: All policies defined for paths

    User's Bind Policies: For each user, captures which policies were assigned to them

Usage
bash

export VAULT_ADDR=<old-vault-cluster-IP>:<port>
export VAULT_TOKEN=<your-old-vault-token>
./general-vault-backup.sh

Creating user.json File

Since user passwords are typically not stored due to privacy concerns, you need to create a user.json file with known user/password combinations using the following pattern:
json

{
  "user1": "pass1",
  "user2": "pass2",
  "user3": "pass3"
}

Restoring Information

After completing the above steps, run the restore script in the same directory. This script will update the new Vault based on the generated outputs.

The restore script performs the following operations on the new Vault:

    Secrets: Restores secrets with the exact same hierarchy as the source

    Policies: Copies all path policies exactly

    User/Pass Auth Method: Automatically enables this method

    User/Pass: Registers user/password information from the user.json file

    User's Bind Policies: Assigns the appropriate policies to each user

Usage
bash

export VAULT_ADDR=<new-vault-cluster-IP>:<port>
export VAULT_TOKEN=<your-new-vault-token>
./general-vault-restore.sh

Testing

The above documentation has been tested on migration from Vault version 1.14.8 to 1.20.3 with successful results. Please note that significant investment has been made in the Vault command behavior within these scripts, so careful attention should be paid to the source version, target version, and system Vault command version.
Prerequisites

    Vault CLI installed and configured

    Appropriate permissions for Vault tokens

    Access to both source and destination Vault clusters

File Structure
text

.
├── general-vault-backup.sh
├── general-vault-restore.sh
├── user.json (to be created by user)
├── backup_secrets/ (generated by backup script)
├── backup_policies/ (generated by backup script)
└── backup_users/ (generated by backup script)

Support

For issues and questions related to these migration scripts, please contact the development team.
